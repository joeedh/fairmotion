<!DOCTYPE html>

<!--
/*
 * Copyright (C) 2009 Apple Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
 -->
<html>
<head>
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">

    <title>FairMotion</title>
    <style>
        body, html {
            margin: 0px;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #framerate {
            position: absolute;
            z-index: 3;
            top: 10px;
            left: 300px;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 1em;
            color: white;
        }

        #tottri {
            position: absolute;
            top: 10px;
            left: 560px;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 1em;
            color: white;
        }
    </style>

    <!--<script type="text/javascript" src="fcontent/common.js"></script>-->
    <script type="text/javascript">
        // Copyright (c) 2013 The Chromium Authors. All rights reserved.
        // Use of this source code is governed by a BSD-style license that can be
        // found in the LICENSE file.

        // This function is called by common.js when the NaCl module is
        // loaded.
        function moduleDidLoad() {
            console.log("-------Loaded NACL module!----------");
            common.hideModule();
            //common.naclModule.postMessage('hello');
        }
        // This function is called by common.js when a message is received from the
        // NaCl module.  it's overriden by src/nacl/nacl_api.js, which is an es6 module(
        function handleMessage(message) {
            //var logEl = document.getElementById('log');
            //logEl.textContent += message.data;

            console.log("NACL message!", message, message.data);
        }

    </script>
    <!--
    This element will be populated with the messages that come from the NaCl
    module. See example.js.
    -->
    <div id="log"></div>

    <script id="2d_basic_vshader" type="x-shader/x-vertex">
    uniform mat4 mat;
    
    attribute vec4 vPosition;
    attribute vec4 vColor;
    attribute vec4 vTexCoord;
    
    varying vec4 g_Color;
    varying vec2 v_texCoord;
    
    void main()
    {
        gl_Position = mat * vPosition;
        v_texCoord = vTexCoord.st;
        g_Color = vColor;    
    }

    </script>

    <script id="2d_basic_fshader" type="x-shader/x-fragment">
    precision mediump float;

    uniform sampler2D iconsampler;
    
    varying vec4 g_Color;
    varying vec2 v_texCoord;
    
    vec4 interp4(vec4 c1, vec4 c2, float t)
    {
      return c1 + (c2 - c1) * t;
    }
    
    void main()
    {
      vec4 clr = vec4(g_Color[0], g_Color[1], g_Color[2], g_Color[3]);
      
      if (v_texCoord[0] >= 0.0 && v_texCoord[1] >= 0.0) {
        vec4 tclr = texture2D(iconsampler, v_texCoord);
        clr = clr * tclr;
      }
      
      gl_FragColor = clr;
    }

    </script>

    <script id="compute_vshader" type="x-shader/x-vertex">
    uniform sampler2D sampler2d;
    uniform sampler2D sampler2d_util_tab;
    
    attribute vec3 vPosition;
    varying vec3 v_Normal;
    
    varying vec4 clr;
    void main()
    {
        clr = vec4(0.7, 0.7, 0.0, 1.0);
        gl_Position = vec4(vPosition[0], vPosition[1], vPosition[2], 1.0);
        v_Normal = vec3(0.0, 0.0, -1.0);
    }

    </script>

    <script id="vshader" type="x-shader/x-vertex">
    precision mediump float;
    
    uniform mat4 u_modelViewProjMatrix;
    uniform mat4 u_cameraMatrix;
    uniform mat4 u_normalMatrix;
    uniform vec3 lightDir1;
    uniform vec4 sel_eid;
    uniform vec4 highsel_eid;
    uniform vec4 high_color;
    uniform vec4 highsel_color;

    attribute vec4 vPosition;
    attribute vec4 vColor;
    attribute vec3 vNormal;
    attribute vec4 vTexCoord;
    attribute vec4 eid;
    
    varying vec4 g_Color;
    varying vec3 v_Normal;
    varying float v_Dot;
    varying vec2 v_texCoord;
    
    void main()
    {
        gl_Position = u_modelViewProjMatrix * vPosition;
        gl_PointSize = 9.0;
        v_texCoord = vTexCoord.st;
        vec4 transNormal = u_normalMatrix * vec4(vNormal, 1);
        
        vec3 plightDir = vec3(u_cameraMatrix * vec4(lightDir1, 1));
        
        v_Dot = max(dot(transNormal.xyz, lightDir1), 0.0);
        
        if (eid == sel_eid)
          g_Color = high_color;
        else if (eid == highsel_eid)
          g_Color = highsel_color;
        else
          g_Color = vColor;
        
        v_Normal = transNormal.xyz;
    }

    </script>


    <script id="editvshader" type="x-shader/x-vertex">
    precision mediump float;
    
    uniform mat4 u_modelViewProjMatrix;
    uniform mat4 u_normalMatrix;
    uniform vec3 lightDir;
    uniform float alpha_mul;
    uniform vec4 face_unsel_color;
    uniform vec4 sel_eid;
    uniform vec4 highsel_eid;
    uniform vec4 high_color;
    uniform vec4 highsel_color;
    
    attribute vec4 vPosition;
    attribute vec4 vColor;
    attribute vec3 vNormal;
    attribute vec4 vTexCoord;
    attribute vec4 eid;
    
    varying float v_Dot;
    varying vec4 g_Color;
    varying vec2 v_texCoord;
    varying vec3 v_Normal;

    void main()
    {
        gl_Position = u_modelViewProjMatrix * vPosition;
        gl_PointSize = 9.0;
        v_texCoord = vTexCoord.st;
        vec4 transNormal = u_normalMatrix * vec4(vNormal, 1);
        v_Dot = 1.0;
        
        if (eid == sel_eid)
          g_Color = high_color;
        else if (eid == highsel_eid)
          g_Color = highsel_color;
        else
          g_Color = vColor;
        
        g_Color[3] *= alpha_mul;
        v_Normal = transNormal.xyz;
    }

    </script>

    <script id="editv_fshader" type="x-shader/x-fragment">
    precision mediump float;
    
    uniform sampler2D sampler2d;
    uniform float alpha_mul;
    
    varying vec4 g_Color;
    varying vec3 v_Normal;

    void main()
    {
      gl_FragColor = g_Color;
    }

    </script>


    <script id="selbuf_vshader" type="x-shader/x-vertex">
    precision mediump float;
    
    uniform mat4 u_modelViewProjMatrix;
    
    attribute vec3 vPosition;
    attribute vec4 vColor;
  
    varying vec4 g_Color;

    void main()
    {
      vec4 pos = vec4(vPosition[0], vPosition[1], vPosition[2], 1.0);
      gl_Position = u_modelViewProjMatrix * pos;
      g_Color = vColor;
      
      gl_PointSize = 9.0;
    }

    </script>

    <script id="selbuf_fshader" type="x-shader/x-fragment">
    precision mediump float;

    uniform sampler2D sampler2d;
    uniform float alpha_mul;
    
    varying vec4 g_Color;
    varying vec3 v_Normal;

    void main()
    {
      gl_FragColor = g_Color;
    }

    </script>

    <script id="ss_fshader" type="x-shader/x-fragment">
    precision mediump float;
    uniform mat4 u_modelViewProjMatrix;
    uniform mat4 u_cameraMatrix;
    uniform mat4 u_normalMatrix;
    uniform vec3 lightDir1;
    uniform float alpha_mul;
    uniform float lightfac_inv;

    uniform sampler2D sampler2d;

    varying vec4 g_Color;
    varying vec3 v_Normal;
    varying float v_Dot;
    varying vec2 v_texCoord;
    
    vec4 interp4(vec4 c1, vec4 c2, float t)
    {
      return c1 + (c2 - c1) * t;
    }
    
    void main()
    {
        vec2 texCoord = vec2(v_texCoord.s, 1.0 - v_texCoord.t);
        vec4 viewvec4 = u_modelViewProjMatrix * gl_FragCoord;
        vec3 viewvec = normalize(viewvec4.xyz);
        
        vec4 color = g_Color; //vec4(0.6, 0.6, 0.6, 1.0); //texture2D(sampler2d, texCoord);
        
        vec4 c1 = vec4(color.xyz*v_Dot, color.a);
        vec4 c2 = vec4(color.xyz*(1.0-v_Dot), color.a);
        
        c1 = interp4(c1, c2, 0.1);
        
        vec3 refl = v_Normal*dot(v_Normal, lightDir1) - lightDir1*0.5;
        refl = refl*-1.0;
        float p = max(dot(refl, viewvec), 0.0);
        p = pow(p, 4.0)*7.80;
        
        c2 = vec4(p, p, p, 1.0);
        if (alpha_mul != 0.0)
          c1[3] *= alpha_mul;
        
        float alpha = alpha_mul == 0.0 ? 1.0 : alpha_mul;
        float f = dot(v_Normal, lightDir1);
        
        f += (1.0 - f)*(lightfac_inv);
        
        //float p = u_modelViewProjMatrix * gl_FragCoord;
        gl_FragColor = vec4(color[0]*f, color[1]*f, color[2]*f, alpha);
    }

    </script>

    <script id="fshader" type="x-shader/x-fragment">
    precision mediump float;
    uniform mat4 u_modelViewProjMatrix;
    uniform mat4 u_cameraMatrix;
    uniform mat4 u_normalMatrix;
    uniform vec3 lightDir1;
    uniform float alpha_mul;
    uniform float lightfac_inv;

    uniform sampler2D sampler2d;

    varying vec4 g_Color;
    varying vec3 v_Normal;
    varying float v_Dot;
    varying vec2 v_texCoord;
    
    vec4 interp4(vec4 c1, vec4 c2, float t)
    {
      return c1 + (c2 - c1) * t;
    }
    
    void main()
    {
        vec2 texCoord = vec2(v_texCoord.s, 1.0 - v_texCoord.t);
        vec4 viewvec4 = u_modelViewProjMatrix * gl_FragCoord;
        vec3 viewvec = normalize(viewvec4.xyz);
        
        vec4 color = g_Color; //vec4(0.6, 0.6, 0.6, 1.0); //texture2D(sampler2d, texCoord);
        
        vec4 c1 = vec4(color.xyz*v_Dot, color.a);
        vec4 c2 = vec4(color.xyz*(1.0-v_Dot), color.a);
        
        c1 = interp4(c1, c2, 0.1);
        
        vec3 refl = v_Normal*dot(v_Normal, lightDir1) - lightDir1*0.5;
        refl = refl*-1.0;
        float p = max(dot(refl, viewvec), 0.0);
        p = pow(p, 4.0)*7.80;
        
        c2 = vec4(p, p, p, 1.0);
        if (alpha_mul != 0.0)
          c1[3] *= alpha_mul;
        
        float alpha = alpha_mul == 0.0 ? 1.0 : alpha_mul;
        float f = dot(v_Normal, lightDir1);
        
        f += (1.0 - f)*(lightfac_inv);
        gl_FragColor = vec4(color[0]*f, color[1]*f, color[2]*f, alpha);
    }

    </script>

    <script id="fshader_flat" type="x-shader/x-fragment">
    precision mediump float;
    uniform vec4 color;
    
    void main()
    {
        gl_FragColor = color;
    }

    </script>

    <script id="fshader_simple" type="x-shader/x-fragment">
    precision mediump float;
    uniform mat4 u_modelViewProjMatrix;
    uniform mat4 u_cameraMatrix;
    uniform mat4 u_normalMatrix;
    uniform vec3 lightDir1;
    uniform float alpha_mul;

    uniform sampler2D sampler2d;

    varying vec4 g_Color;
    varying vec3 v_Normal;
    varying float v_Dot;
    varying vec2 v_texCoord;
    
    vec4 interp4(vec4 c1, vec4 c2, float t)
    {
      return c1 + (c2 - c1) * t;
    }
    
    void main()
    {
        vec4 color = g_Color;
        
        if (alpha_mul != 0.0)
          color[3] *= alpha_mul;
        
        gl_FragColor = color;
    }

    </script>

    <script id="2d_line_vshader" type="x-shader/x-vertex">
    precision mediump float;
    uniform vec4 uColor;

    attribute vec4 vPosition;
    attribute vec2 vUV;
    attribute vec4 vColor;
    
    varying vec4 g_Color;
    varying vec2 v_UV;
    void main()
    {
       gl_Position = vPosition;
       g_Color = vColor;
       v_UV = vUV;
    }

    </script>

    <script id="2d_line_fshader" type="x-shader/x-fragment">
    precision mediump float;
    uniform vec2 viewport; //size

    varying vec4 g_Color;
    varying vec2 v_UV;
    
    float line_mod(float wid, float space) {
      float u = v_UV[0]*viewport[0];
      float v = v_UV[1]*viewport[1];
      
      float m = sqrt(u*u + v*v);
      float tot = wid+space;
      float totfac = 1.0 / tot;
      
      m = mod(m, tot) * totfac;
      wid *= totfac; space *= totfac;
      
      if (m < wid) m = 1.0;
      else m = 0.0;
      
      return m;
    }
    
    void main()
    {
      vec4 clr = g_Color;
      
      clr[3] *= line_mod(20.0, 20.0);
      
      gl_FragColor = clr;
    }

    </script>

    <script id="2d_rect_vshader" type="x-shader/x-vertex">
    precision mediump float;
    uniform vec4 color;

    attribute vec4 vPosition;
    
    void main()
    {
       gl_Position = vPosition;
    }

    </script>

    <script id="2d_rect_fshader" type="x-shader/x-fragment">
    precision mediump float;
    uniform vec4 color;
    
    void main()
    {
      gl_FragColor = color;
    }

    </script>

    <script id="2d_text_vshader" type="x-shader/x-vertex">
    precision mediump float;
    uniform vec4 uColor;
    uniform mat4 uMatrix;
    
    attribute vec2 vPosition;
    attribute vec2 vTexCoord;
    
    varying vec4 g_Color;
    varying vec2 g_TexCoord;
    void main()
    {
       vec4 pos = uMatrix * vec4(vPosition[0], vPosition[1], 0, 1);
       pos[3] = 1.0;
       
       gl_Position = pos;
       g_TexCoord = vTexCoord;
       g_Color = uColor;
    }

    </script>

    <script id="2d_text_fshader" type="x-shader/x-fragment">
    precision mediump float;
    
    uniform sampler2D sampler2d;
    
    varying vec4 g_Color;
    varying vec2 g_TexCoord;
    
    void main()
    {
      vec4 clr = g_Color;
      clr[3] = texture2D(sampler2d, g_TexCoord)[0];
      
      gl_FragColor = clr;
    }

    </script>

    <!-- runtime boilerplate for extended JS system -->
    <script>
        window.mobilecheck = function () {
            var str = navigator.userAgent + navigator.vendor;

            function test(s) {
                var ret = str.match(s)
                if (ret == null || ret == undefined) return false;
                if (ret.length == 0 || ret.length == undefined)
                    return false;

                return true;
            }

            str = str.toLowerCase();
            var ret = test("android") || test("mobile") || test("blackberry") || test("iphone")

            return ret;
        }

        IsMobile = window.mobilecheck();

        //mobile-specific settings
        if (IsMobile) {
            use_octree_select = true; //use ray tracing, not the framebuffer, for cull selection mode
        }
        /*
         window.mobilecheck = function() {
         var check = false;
         (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check = true})(navigator.userAgent||navigator.vendor||window.opera);
         return check; }
         */

        /*check for various api calls that aren't implemented by all browsers*/
        if (String.startsWith == undefined) {
            String.prototype.startsWith = function (str) {
                if (str.length > this.length)
                    return false;

                for (var i = 0; i < str.length; i++) {
                    if (this[i] != str[i])
                        return false;
                }

                return true;
            }
        }

        if (String.endsWith == undefined) {
            String.prototype.endsWith = function (str) {
                if (str.length > this.length)
                    return false;

                for (var i = 0; i < str.length; i++) {
                    if (this[this.length - str.length + i] != str[i])
                        return false;
                }

                return true;
            }
        }

        //this needs to be converted to use regexpr's
        if (String.contains == undefined) {
            String.prototype.contains = function (str) {
                if (str.length > this.length)
                    return false;

                for (var i = 0; i < this.length - str.length + 1; i++) {
                    var found = true;
                    for (var j = 0; j < str.length; j++) {
                        if (this[i + j] != str[j]) {
                            found = false;
                            break;
                        }
                    }

                    if (found)
                        return true;
                }

                return false;
            }
        }

        //we probably should get rid of this function
        String.prototype.find = function (str) {
            if (str.length > this.length)
                return false;

            for (var i = 0; i < this.length - str.length + 1; i++) {
                var found = true;
                for (var j = 0; j < str.length; j++) {
                    if (this[i + j] != str[j]) {
                        found = false;
                        break;
                    }
                }

                if (found)
                    return i;
            }

            return -1;
        }

        //more consistent is_str function
        function is_str(str) {
            return typeof str == "string" || typeof str == "String";
        }

        //get type name, even for mangled objects
        function get_type_name(obj) {
            if (obj == undefined) return "undefined"
            if (obj.constructor != undefined && obj.constructor.name != undefined && obj.constructor.name != "")
                return obj.constructor.name;

            var c;

            try {
                var c = obj.toSource()
            } catch (Error) {
                c = ""
            }

            if (obj.toString().startsWith("[object ")) {
                var c2 = obj.toString().replace("[object ", "").replace("]", "")
                if (c2 != "Object" && c2 != "Array") {
                    return c2;
                }
            }

            if (c.contains(">") && c.contains("<") && !c.contains(" ") && !c.contains(",") && !c.contains(".")) {
                c = c.replace(">", "").replace("<", "")

                if (c != "Object" && c != "Array") {
                    return c
                }
            }

            if (obj.constructor == MouseEvent)
                return "MouseEvent"

            if (obj.constructor == KeyEvent)
                return "KeyEvent"

            if (obj.constructor == KeyboardEvent)
                return "KeyboardEvent"

            return "(unknown)";
        }

        log_cache = {}
        slog_queue = []
        flush_queue = false;
        last_queue_time = window.performance.now();

        function server_log(msg) {
            return; //XXX

            if (msg != undefined) {
                if (log_cache.hasOwnProperty(msg))
                    return;

                log_cache[msg] = msg;
                slog_queue.push(msg)
            }

            console.log(window.performance.now() - last_queue_time);
            if ((slog_queue.length > 0 && window.performance.now() - last_queue_time > 1500) || flush_queue) {
                flush_queue = false;
                console.log("flushing...")

                var req = new XMLHttpRequest();
                req.open("POST", "/logger", true);
                req.setRequestHeader("Content-type", "text/text");
                req.onreadystatechange = function () {
                    if (req.readyState == 4 && req.status == 200) {
                        var resp = req.responseText;
                        console.log("read response", resp)
                    }
                }

                buf = ""
                for (var i = 0; i < slog_queue.length; i++) {
                    buf += slog_queue[i] + "\n";
                }

                req.send(buf);
                slog_queue = [];
                last_queue_time = window.performance.now();
            }
        }

        function flush_server_log() {
            flush_queue = true;
            server_log();
        }

        //a basic array iterator utility function
        function arr_iter(keys) {
            this.ret = {done: false, value: undefined};
            this.keys = keys;
            this.cur = 0;

            this.__iterator__ = function () {
                return this;
            }

            this.next = function () {
                if (this.cur >= this.keys.length) {
                    this.ret.done = true;

                    return this.ret;
                }

                this.ret.value = this.keys[this.cur++];
                return this.ret;
            }
        }

        //not every browser implements JS1.7 Harmony iterators
        /*
         try {
         var i = StopIteration;
         } catch (error) {
         StopIteration = function(msg) {
         Error.call(this, msg);
         }
         StopIteration.prototype = Object.create(Error.prototype);
         StopIteration.prototype.constructor = StopIteration;
         }
         */

        function obj_get_keys(obj) {
            var ret = [];

            for (var k in obj) {
                if (obj.hasOwnProperty(k))
                    ret.push(k);
            }

            return ret;
        }

        _do_frame_debug = false;
        _do_iter_err_stacktrace = true;

        //special values for compiled generator code
        FrameContinue = {"FC": 1}
        FrameBreak = {"FB": 1}

        /*not sure if I need these...*/
        function getattr(obj, attr) {
            return obj[attr];
        }
        function setattr(obj, attr, val) {
            obj[attr] = val;
        }
        function delattr(obj, attr) {
            delete obj[attr];
        }

        /*the grand __get_iter function.
         extjs_cc does not use c.__it erator__ when
         compiling code like "for (var a in c)" to
         ECMAScript5.1; rather, it calls __get_iter(c).
         */
        /*
         function __get_iter(obj)
         {
         if (obj == undefined) {
         console.trace();
         print_stack();
         throw new Error("Invalid iteration over undefined value")
         }

         if (obj.__proto__.hasOwnProperty("__iterator__") || obj.hasOwnProperty("__iterator__")) {
         return obj.__iterator__();
         } else {
         keys = []
         for (var k in obj) {
         keys.push(k)
         }
         return new arr_iter(keys);
         }
         }
         */

        function _KeyValIterator(obj) {
            if (obj.__proto__.hasOwnProperty("__iterator__") || obj.hasOwnProperty("__iterator__")) {
                return obj.__iterator__();
            } else {
                var keys = []
                for (var k in obj) {
                    keys.push([k, obj[k]])
                }
                return new arr_iter(keys);
            }
        }

        Iterator = _KeyValIterator;

        /*
         with any luck, all browsers have JSON.stringify and JSON.parse

         function tab_indent(tlevel, tstr) {
         if (tlevel == undefined) return ""
         if (tstr == undefined)
         tstr = " ";

         var s = ""
         for (var i=0; i<tlevel; i++) {
         s += tstr;
         }

         return s;
         }

         function toJSON_intern (ob, tlevel) {
         if (tlevel == undefined) tlevel = 0;
         var tab = tab_indent(tlevel+1);

         var s = tab

         if (obj instanceof Array) {
         } else if (obj instanceof String) {
         } else if (obj instanceof Number) {
         } else if (obj instanceof Boolean) {
         } else {
         s = tab_indent(tlevel) + "{\n"
         var i =0;
         for (var k in this) {
         if (this[k] == this) continue;
         if (this[k] == "prototype") continue;
         if (!this.hasOwnProperty(k)) continue;
         if (i > 0) s += ",\n";

         if (this[k] != undefined) {
         var val = this[k];
         if (typeof val == "function") continue;

         if (!(val instanceof Array) &&
         !(val instanceof String) &&
         !(val instanceof Number) &&
         !(val instanceof Boolean))
         {
         console.trace();
         throw new Error("Can only json simple objects")
         break;
         }
         }

         s += tab + "\"" + k + "\"" + " : " + toJSON(this[k], tlevel+1)

         i += 1;
         }
         s += "}"
         }

         return s
         }
         */

    </script>

    <script type="text/javascript" src="fcontent/app.js"></script>

    <script>
        load_modules();

        //put modules into global namespace for debugging purposes
        //prepend "_" to their names so, e.g. spline becomes _spline
        for (var k in _defined_modules) {
            var mod = _defined_modules[k];
            window["_" + k] = mod.exports;
        }

        var g = {};
        var _skip_draw = false;

        var _fallback_bg = [0.25, .3, .6, 1];
        function init_gl() {
            // Initialize
            /*
             var gl = initWebGL(
             // The id of the Canvas Element
             "canvas2d_work");

             if (!gl) {
             return undefined;
             }*/

            if (DEBUG.gl_objects) {
                gld = new WebGLObjManager();
                gld.patch_gl(gl);
            }

            if (window.colors3d != undefined) {
                var view2d_bg = colors3d["Background"];
                if (view2d_bg == undefined)
                    view2d_bg = _fallback_bg;
            } else {
                var view2d_bg = _fallback_bg;
            }

            // Set some uniform variables for the shaders
            var l1 = new Vector3([0, 0.5, 1])
            var l2 = new Vector3([0.5, 0, 1])

            l1.normalize();
            l2.normalize();
        }

        function init() {
            window.redraw_rect_combined = [new Vector3(), new Vector3()];
            window.redraw_rect = [new Vector3(), new Vector3()]; //[[0, 0, 0], [0, 0, 0]];
            window.last_redraw_rect = [new Vector3(), new Vector3()];
            window.redraw_rect_defined = false;
            window.redraw_whole_screen = false;
            var animreq = undefined;

            var animreq_ui = undefined;
            var block_ui_draw = false;

            window.block_redraw_ui = function () {
                var oldval = block_ui_draw;
                block_ui_draw = true;
                return oldval;
            }

            window.unblock_redraw_ui = function () {
                var oldval = block_ui_draw;
                block_ui_draw = false;
                return oldval;
            }

            window.redraw_ui = function () {
                if (block_ui_draw) return;

                //console.trace("ui redraw", animreq_ui);
                if (animreq_ui == undefined) {
                    animreq_ui = window.requestAnimationFrame(function () {
                        animreq_ui = undefined;

                        //console.log("ui frame");

                        if (g_app_state != undefined)
                            g_app_state.eventhandler.on_draw();
                    });
                }
            }
            
            window.redraw_viewport_p = function(min, max, promise) {
              promise.then(function() {
                window.redraw_viewport(min, max);
              });
            }
            
            window.force_viewport_redraw = function () {
                redraw_whole_screen = true;
                window.redraw_whole_screen = true;
            }

            window.redraw_viewport = function (min, max) {
                if (redraw_whole_screen)
                    min = max = undefined;

                if (window._trace) {
                    console.trace();
                }

                if (animreq == undefined) {
                    animreq = window.requestAnimationFrame(function () {
                        redraw_whole_screen = false;
                        animreq = undefined;

                        for (var i = 0; i < g_app_state.screen.children.length; i++) {
                            var c = g_app_state.screen.children[i];

                            if (c.constructor.name == "ScreenArea" &&
                                    c.area.constructor.name == "View2DHandler") {
                                c.area.do_recalc();
                            }
                        }

                        if (g_app_state != undefined)
                            g_app_state.eventhandler.on_draw();

                        window.redraw_rect[0].zero();
                        window.redraw_rect[1].zero();
                    });
                }

                if (min == undefined) {
                    window.redraw_whole_screen = true;

                    if (!redraw_rect_defined || redraw_whole_screen) {
                        window.redraw_rect[0].zero();
                        window.redraw_rect[1].zero();
                        window.redraw_rect[0][0] = window.redraw_rect[0][1] = 0;
                        window.redraw_rect[1][0] = window.innerWidth;
                        window.redraw_rect[1][1] = window.innerHeight;

                        if (_canvas2d_ctx_2._irender_mat != undefined) {
                            window.redraw_rect[0].multVecMatrix(_canvas2d_ctx_2._irender_mat);
                            window.redraw_rect[1].multVecMatrix(_canvas2d_ctx_2._irender_mat);
                        }
                    }
                } else if (redraw_rect_defined) {
                    var h = window.innerHeight;

                    window.redraw_rect[0][0] = Math.min(min[0], window.redraw_rect[0][0]);
                    window.redraw_rect[0][1] = Math.min(min[1], window.redraw_rect[0][1]);

                    window.redraw_rect[1][0] = Math.max(max[0], window.redraw_rect[1][0]);
                    window.redraw_rect[1][1] = Math.max(max[1], window.redraw_rect[1][1]);
                } else {
                    window.redraw_rect[0][0] = min[0];
                    window.redraw_rect[0][1] = min[1];
                    window.redraw_rect[1][0] = max[0];
                    window.redraw_rect[1][1] = max[1];
                    window.redraw_rect_defined = true;
                }

                if (g_app_state == undefined || g_app_state.screen == undefined)
                    return;

                var g = g_app_state;
                var cs = g.screen.children;
                for (var i = 0; i < cs.length; i++) {
                    var c = cs[i];

                    if (c.constructor.name == "ScreenArea" && c.area.draw_viewport != undefined) {
                        c.area.draw_viewport = 1; //flag update for view2d
                    }
                }
            }
            //init_ctxloss_ext();
            init_theme();

            var canvas = document.getElementById('canvas2d_work');

            if (g != undefined)
                g.canvas = canvas;

            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;

            //don't mangle current app state on
            //context loss, which also calls init()
            if (g_app_state == undefined) {
                //initialize struct pack system
                init_struct_packer();

                console.log("initializing data api...");
                api_define_ops();
                api_define_context();

                init_event_graph();

                g_app_state = new AppState(undefined, undefined, undefined);
                g_app_state.size = [canvas.clientWidth, canvas.clientHeight];

                console.log("generating start file...");
                gen_default_file([canvas.clientWidth, canvas.clientHeight]);

                g_app_state.session.validate_session();
            }
        }

        var requestId;
        window._fps = 1;

        function reshape(gl) {
            var g = window.g_app_state;
            if (g == undefined)
                return;

            // change the size of the canvas's backing store to match the size it is displayed.
            var canvas = document.getElementById('canvas2d_work');
            var canvas2d = document.getElementById("canvas2d")

            g.canvas = canvas;
            g.canvas2d = canvas2d;

            //ensure canvas2d'd dimensions are correct
            if (canvas2d.width != canvas.clientWidth || canvas2d.height != canvas.clientHeight) {
                canvas2d.clientWidth = canvas.clientWidth;
                canvas2d.clientHeight = canvas.clientHeight;
                canvas2d.width = canvas.clientWidth;
                canvas2d.height = canvas.clientHeight;

                window.redraw_viewport();

                if (g != undefined && g.screen != undefined) {
                    g.screen.do_full_recalc();
                    window.redraw_ui();
                }
            }

            var width = window.innerWidth, height = window.innerHeight;

            if (canvas.width == width && canvas.height == height)
                return;

            var oldsize = [canvas.width, canvas.height]
            var newsize = [width, height]

            canvas.width = width;
            canvas.height = height;

            g.size = new Vector2(newsize);

            if (g.screen != undefined) {
                g.screen.do_full_recalc();
                g.eventhandler.on_resize(newsize, oldsize);

                window.redraw_ui();
            }
        }

        var g = g_app_state;

        window._stime = 10;

        window.setInterval(function () {
            if (window.skip_draw) return;

            var g = window.g_app_state;
            if (g == undefined) return;

            //Make sure the canvas is sized correctly.
            reshape();

            //var canvas = g.canvas = document.getElementById('canvas2d_work');
            //g.eventhandler.on_draw(undefined);

            window.redraw_rect_defined = false;
            window.redraw_whole_screen = false;
        }, 200);

        window.setInterval(function () {
            if (g_app_state != undefined && g_app_state.screen != undefined) {
                g_app_state.screen._on_tick();
            }
        }, 32);

        function drawPicture(gl) {
            var g = g_app_state;

            // Make sure the canvas is sized correctly.
            reshape(gl);

            var canvas = g.canvas = document.getElementById('canvas2d_work');

            if (g != undefined && g.eventhandler != undefined) {
                if (DEBUG != undefined && DEBUG.alias_g_app_state) {
                    G = g_app_state;
                }
                g.eventhandler.on_draw(undefined);

                // Show the framerate
                var time = time_ms() - fps_start;
                fps_start = time_ms();

                var fps = 1000 / framerate.update(time);
                window._fps = fps;

                //document.getElementById("framerate").innerHTML =
                //  "Framerate: " + fps.toFixed(1);
            }
        }

        /*
         function canvas2d_anim_frame() {
         window.requestAnimationFrame(canvas2d_anim_frame, canvas2d);
         }
         */

        _canvas2d_ctx = undefined;
        _canvas2d_ctx_2 = undefined;
        _draw_gl = undefined;

        function start() {
            var canvas;
            var c = canvas = document.getElementById("canvas2d_work");

            var canvas2d = document.getElementById("canvas2d");

            _canvas2d_ctx = canvas2d.getContext("2d");
            _canvas2d_ctx_2 = canvas.getContext("2d");

            window.canvas2d_work = _canvas2d_ctx_2;

            //_canvas2d_ctx.globalAlpha = 1.0;
            _canvas2d_ctx.fillStyle = "blue";
            _canvas2d_ctx.clearRect(0, 0, 200, 200);
            _canvas2d_ctx.globalCompositeOperation = "source-over";
            _canvas2d_ctx.font = "bold 16px Arial";

            _canvas2d_ctx.fillStyle = "blue";
            _canvas2d_ctx.fillRect(0, 0, 100, 100);

            //window.requestAnimationFrame(canvas2d_anim_frame, canvas2d);

            document.onselectstart = new Function("return false")
            document.oncontextmenu = new Function("return false")
            //c = WebGLDebugUtils.makeLostContextSimulatingCanvas(c);
            // tell the simulator when to lose context.
            //c.loseContextInNCalls(1);
            //c.contentEditable = true;
            //document.designMode = true;

            var ce = canvas2d; //DEBUG.use_2d_uicanvas ? canvas2d : canvas;

            ce.addEventListener("mousemove", handleMouseMove, false);
            ce.addEventListener("mousedown", handleMouseDown, false);
            ce.addEventListener("touchstart", handleTouchDown, false);
            ce.addEventListener("touchmove", handleTouchMove, false);
            ce.addEventListener("mouseup", handleMouseUp, false);
            ce.addEventListener("touchend", handleTouchUp, false);
            ce.addEventListener("touchcancel", handleTouchCancel, false);

            window.addEventListener("DOMMouseScroll", handleMouseWheel, false);
            window.addEventListener("mousewheel", handleMouseWheel, false);

            document.addEventListener("keydown", handleKeyDown, false);
            document.addEventListener("keyup", handleKeyUp, false);

            document.addEventListener("keypress", handleKeyPress, false);
            document.addEventListener("textinput", handleTextInput);
            document.addEventListener("input", handleTextInput);

            init();

            framerate = new movavg(25);
            fps_start = time_ms();

            var last_draw = time_ms();
            var last_draw2 = time_ms();
            var miss = undefined;

            var f = function () {
                var time = time_ms() - last_draw;
                var skip = false;

                if (0 && miss != undefined) {
                    miss -= time;

                    window.miss = miss;

                    if (miss <= 10) {
                        miss = undefined;
                    } else {
                        last_draw = time_ms();
                        skip = true;
                    }
                } else if (0) { //time > 16) {
                    var gap = _fps / 30.0;
                    miss = time;

                    //gap = (_fps - gap) / 30.0;
                    //gap = gap < 0 ? 2.0 : gap;

                    //last_draw = time_ms();
                    skip = gap < 1.0 && Math.random() > gap * 2;
                }

                if (!skip)
                    last_draw = time_ms();

                try {
                    if (!skip && !_skip_draw)
                        drawPicture(_draw_gl);
                } catch (_error) {
                    print_stack(_error);
                    console.log("Draw error: ", _error.message);
                    _skip_draw = true;
                }

                requestId = window.requestAnimationFrame(f, canvas);
            };

            if (g_app_state != undefined) {
                g_app_state.anim_start_func = f;
            }

            //f();

            function stop_event_propegation(e) {
                //e.stopImmediatePropagation();
                e.stopPropagation();
                e.preventDefault();
            }


            function handleTouchMove(e) {
                if (gl_ctx_lost) return;

                g_app_state.was_touch = true;
                stop_event_propegation(e);

                if (g_app_state.eventhandler != undefined) {
                    touch_manager.owner = g_app_state.screen;
                    var x, y;

                    var t = e.targetTouches[0];
                    if (t == undefined) {
                        x = g_app_state._last_touch_mpos[0];
                        y = g_app_state._last_touch_mpos[1];
                    } else {
                        x = t.pageX;
                        y = g_app_state.screen.size[1] - t.pageY;

                        g_app_state._last_touch_mpos[0] = x;
                        g_app_state._last_touch_mpos[1] = y;
                    }

                    var e2 = new MyMouseEvent(x, y, 0, MyMouseEvent.MOUSEMOVE);
                    e2.touches = do_touches(e);

                    touch_manager.queue_event(e2);
                }
            }

            function handleMouseMove(e) {
                if (gl_ctx_lost) return;

                g_app_state.was_touch = false;
                if (g_app_state.eventhandler != undefined) {
                    // console.log(g_app_state.eventhandler.modalhander);

                    var evt = new MyMouseEvent(e.pageX, g_app_state.screen.size[1] - e.pageY, 0,
                            MyMouseEvent.MOUSEMOVE);
                    g_app_state.eventhandler._on_mousemove(evt);
                }
            }

            function handleMouseWheel(event) {
                if (gl_ctx_lost) return;

                //code kindly taken from http://www.adomas.org/javascript-mouse-wheel/

                var delta = 0;
                if (!event) /* For IE. */
                    event = window.event;
                if (event.wheelDelta) { /* IE/Opera. */
                    delta = event.wheelDelta / 120;
                } else if (event.detail) { /** Mozilla case. */
                    /** In Mozilla, sign of delta is different than in IE.
                     * Also, delta is multiple of 3.
                     */
                    delta = -event.detail / 3;
                }

                /** If delta is nonzero, handle it.
                 * Basically, delta is now positive if wheel was scrolled up,
                 * and negative, if wheel was scrolled down.
                 */

                /** Prevent default actions caused by mouse wheel.
                 * That might be ugly, but we handle scrolls somehow
                 * anyway, so don't bother here..
                 */
                if (event.preventDefault)
                    event.preventDefault();
                event.returnValue = false;

                if (delta && g_app_state.screen != undefined) {
                    event.x = event.pageX;
                    event.y = g_app_state.screen.size[1] - event.pageY;

                    g_app_state.eventhandler._on_mousewheel(event, delta);
                }
            }

            function handleTouchCancel(e) {
                if (gl_ctx_lost) return;

                if (t == undefined) {
                    x = e.pageX;
                    y = e.pageY;
                } else {
                    x = t.pageX;
                    y = t.pageY;
                }

                var lst = e.changedTouches;
                var touches = {};
                for (var i = 0; i < t.length; i++) {
                    touches[lst[i].identifier] = [x, y];
                }

                console.log("touch cancel");

                if (g_app_state.screen != undefined) {
                    touch_manager.owner = g_app_state.screen;
                    var e2 = new MyMouseEvent(x, g_app_state.screen.size[1] - y, 0, MyMouseEvent.MOUSEUP);

                    e2.shiftKey = e.shiftKey;
                    e2.altKey = e.altKey;
                    e2.ctrlKey = e.ctrlKey;

                    touch_manager.cancel(e2);
                }
            }

            function do_touches(e) {
                var ts = {};

                var in_ts = e.changedTouches.length == 0 ? e.targetTouches : e.changedTouches;
                if (in_ts == undefined || in_ts.length == 0) return [];

                for (var i = 0; i < in_ts.length; i++) {
                    var id = in_ts[i].identifier;
                    if (id == undefined)
                        id = i;

                    //console.log("-", in_ts[i]);
                    ts[id] = [in_ts[i].pageX, g_app_state.screen.size[1] - in_ts[i].pageY];
                }

                return ts;
            }

            function handleTouchDown(e) {
                if (gl_ctx_lost) return;

                g_app_state.was_touch = true;
                stop_event_propegation(e);

                var x, y;

                if (DEBUG.touch == 2)
                    console.log(e.targetTouches.length, e);

                var t = e.targetTouches[0];
                if (t == undefined) {
                    x = g_app_state._last_touch_mpos[0];
                    y = g_app_state._last_touch_mpos[1];
                } else {
                    x = t.pageX;
                    y = g_app_state.screen.size[1] - t.pageY;

                    g_app_state._last_touch_mpos[0] = x;
                    g_app_state._last_touch_mpos[1] = y;
                }

                if (g_app_state.screen != undefined) {
                    touch_manager.owner = g_app_state.screen;
                    var e2 = new MyMouseEvent(x, y, 0, MyMouseEvent.MOUSEDOWN);

                    e2.shiftKey = e.shiftKey;
                    e2.altKey = e.altKey;
                    e2.ctrlKey = e.ctrlKey;
                    e2.touches = do_touches(e);

                    touch_manager.queue_event(e2);
                }
            }

            function handleTouchUp(e) {
                if (gl_ctx_lost) return;

                g_app_state.was_touch = true;
                stop_event_propegation(e);

                var x, y;

                if (DEBUG.touch == 2)
                    console.log(e);

                var t = e.targetTouches[0];
                if (t == undefined) {
                    x = g_app_state._last_touch_mpos[0];
                    y = g_app_state._last_touch_mpos[1];
                } else {
                    x = t.pageX;
                    y = g_app_state.screen.size[1] - t.pageY;

                    g_app_state._last_touch_mpos[0] = x;
                    g_app_state._last_touch_mpos[1] = y;
                }

                if (g_app_state.screen != undefined) {
                    touch_manager.owner = g_app_state.screen;
                    var e2 = new MyMouseEvent(x, y, 0, MyMouseEvent.MOUSEUP);

                    e2.shiftKey = e.shiftKey;
                    e2.altKey = e.altKey;
                    e2.ctrlKey = e.ctrlKey;
                    e2.touches = do_touches(e);

                    touch_manager.queue_event(e2);
                }
            }

            var last_mouse_down = time_ms();
            var last_mouse_pos = [0, 0];
            var last_mouse_button = 0;
            var DBCLK_THRESH = 200

            function handleMouseDown(e) {
                if (gl_ctx_lost) return;

                g_app_state.was_touch = false;
                if (g_app_state.screen != undefined) {
                    var e2 = new MyMouseEvent(e.pageX, g_app_state.screen.size[1] - e.pageY,
                            e.button, MyMouseEvent.MOUSEDOWN);

                    e2.shiftKey = e.shiftKey;
                    e2.altKey = e.altKey;
                    e2.ctrlKey = e.ctrlKey;

                    //console.log("md1", e.x, e.y);
                    g_app_state.eventhandler._on_mousedown(e2);

                    var is_dclick = last_mouse_button == e.button && time_ms() - last_mouse_down < DBCLK_THRESH;
                    var dx = last_mouse_pos[0] - e.pageX, dy = last_mouse_pos[1] - e.pageY;
                    is_dclick = is_dclick && Math.sqrt(dx * dx + dy * dy) < 10; //mouse hasn't moved more than ten pixels

                    last_mouse_down = time_ms();
                    last_mouse_button = e.button;
                    last_mouse_pos[0] = e.pageX;
                    last_mouse_pos[1] = e.pageY;

                    if (is_dclick) {
                        e2 = new MyMouseEvent(e.pageX, g_app_state.screen.size[1] - e.pageY,
                                e.button, MyMouseEvent.MOUSEDOWN);

                        e2.shiftKey = e.shiftKey;
                        e2.altKey = e.altKey;
                        e2.ctrlKey = e.ctrlKey;

                        g_app_state.eventhandler._on_doubleclick(e2);
                    }

                    //console.log("md2", e.x, e.y);
                }

                if (e.button == 2) {
                    stop_event_propegation(e);
                    return false;
                }
            }

            function handleMouseUp(e) {
                if (gl_ctx_lost) return;

                g_app_state.was_touch = false;
                if (g_app_state.screen != undefined) {
                    var e2 = new MyMouseEvent(e.pageX, g_app_state.screen.size[1] - e.pageY,
                            e.button, MyMouseEvent.MOUSEUP);

                    e2.shiftKey = e.shiftKey;
                    e2.altKey = e.altKey;
                    e2.ctrlKey = e.ctrlKey;

                    g_app_state.eventhandler._on_mouseup(e2);
                }

                if (e.button == 2) {
                    stop_event_propegation(e);
                    return false;
                }
            }

            function gen_keystr(key, keystate) {
                if (typeof key == "number") {
                    key = String.fromCharCode(key)
                }

                var s = key.toUpperCase()
                if (keystate.shift)
                    s = "SHIFT-" + s
                if (keystate.alt)
                    s = "ALT-" + s
                if (keystate.ctrl)
                    s = "CTRL-" + s
                return s
            }

            var key_exclude_list = ke = {};

            ke[gen_keystr("O", {shift: false, alt: false, ctrl: true})] = 0;
            ke[gen_keystr("R", {shift: false, alt: false, ctrl: true})] = 0;
            ke[gen_keystr("N", {shift: false, alt: false, ctrl: true})] = 0;
            ke[gen_keystr("S", {shift: false, alt: false, ctrl: true})] = 0;
            ke[gen_keystr("S", {shift: false, alt: true, ctrl: true})] = 0;
            ke[gen_keystr("P", {shift: false, alt: false, ctrl: true})] = 0;
            ke[gen_keystr("A", {shift: false, alt: false, ctrl: true})] = 0;
            ke[gen_keystr("BACKSPACE", {shift: false, alt: false, ctrl: false})] = 0;
            ke[gen_keystr("TAB", {shift: false, alt: false, ctrl: false})] = 0;
            ke[gen_keystr("V", {shift: false, alt: false, ctrl: true})] = 0;
            ke[gen_keystr("E", {shift: false, alt: false, ctrl: true})] = 0;
            ke[gen_keystr("F", {shift: false, alt: false, ctrl: true})] = 0;
            ke[gen_keystr("G", {shift: false, alt: false, ctrl: true})] = 0;
            ke[gen_keystr("G", {shift: true, alt: false, ctrl: true})] = 0;
            ke[gen_keystr("G", {shift: false, alt: true, ctrl: false})] = 0;

            function handle_key_exclude(e) {
                var kc = charmap[e.keyCode];
                if (kc == undefined)
                    kc = "";

                var keystr = gen_keystr(kc, {
                    shift: e.shiftKey,
                    alt: e.altKey, ctrl: e.ctrlKey
                })

                keystr = keystr.toString().toUpperCase()
                if (keystr in key_exclude_list) {
                    stop_event_propegation(e);
                }
            }

            function handleKeyDown(e) {
                handle_key_exclude(e);
                if (gl_ctx_lost) return;


                if (g_app_state.screen != undefined)
                    g_app_state.eventhandler._on_keydown(e)
            }

            function handleKeyUp(e) {
                handle_key_exclude(e);
                if (gl_ctx_lost) return;


                if (g_app_state.screen != undefined)
                    g_app_state.eventhandler._on_keyup(e);
            }

            function handleKeyPress(e) {
                //console.log("got keypress", e, gl_ctx_lost);

                handle_key_exclude(e);
                if (gl_ctx_lost) return;


                if (g_app_state.screen != undefined) {
                    if (e.charCode == 0 || e.charCode == 13 || e.charCode == undefined)
                        return;

                    e.char = String.fromCharCode(e.charCode);
                    g_app_state.eventhandler._on_charcode(e);
                }
            }

            function handleTextInput(e, e2) {
                //console.log("ya0", e, e2);

                uevt = e;
                if (g_app_state.screen != undefined) {
                    var canvas = document.getElementById("canvas2d_work");
                    var text = "" + canvas.textContent;

                    //we have to maintain something in the text buffer at
                    //at times for the mobile keyboard to show up.
                    if (text.length == 0)
                        canvas.textContent = "<TK>";

                    text = text.replace(/\<TK\>/g, "");

                    //console.log("textinput event");
                    g_app_state.eventhandler._on_textinput({text: text});
                }
            }

            var gl_ctx_lost = false;
        }
    </script>
    <style type="text/css">
        #canvas2d {
            background: "rgba(255,255,255,0.0)";
            position: absolute;
            left: 0px;
            right: 0px;
            z-index: 1;
        }

        #canvas2d_work {
            background: "rgba(255,255,255,1.0)";
            position: absolute;
            left: 0px;
            right: 0px;
            z-index: 0;
        }

        body {
            overflow: hidden;
            width: 100%;
        }

        #fileinput {
            visibility: visible;
            position: absolute;
            left: 700px;
            right: 400px;
            z-index: 2;
        }


    </style>
</head>

<!--  onload="start()"-->

<body onload="start()" data-width="0" data-height="480" data-name="graphics_3d"
      data-tools="pnacl newlib glibc clang-newlib win" data-configs="Debug Release"
      data-path="/fcontent">

<canvas id="canvas2d_work"></canvas>
<canvas id="canvas2d"></canvas>
<!--<div id="framerate">Framerate:51fps</div>-->

<!--<form>
    <input type="file" id="fileinput"></input>
</form>
-->

<!--for nacl-->
<div id="listener"></div>
</body>
</html>
